#!/bin/bash
set -e

echo "ðŸš€ INICIANDO MODO PRODUÃ‡ÃƒO"

# Aguarda PostgreSQL
echo "Aguardando PostgreSQL..."
while ! nc -z db 5432; do
  sleep 1
done
echo "âœ… PostgreSQL pronto!"

# Aguarda Redis
echo "Aguardando Redis..."
while ! nc -z redis 6379; do
  sleep 1
done
echo "âœ… Redis pronto!"

python manage.py migrate --noinput

# âœ… CORREÃ‡ÃƒO: SÃ³ fazer collectstatic se o diretÃ³rio estiver vazio
if [ -z "$(ls -A /app/staticfiles)" ]; then
    echo "ðŸ“¦ Coletando arquivos estÃ¡ticos..."
    python manage.py collectstatic --noinput
else
    echo "ðŸ“¦ Arquivos estÃ¡ticos jÃ¡ coletados"
fi

echo "ðŸš€ Servidor Gunicorn iniciando..."
exec gunicorn --bind 0.0.0.0:8000 config.wsgi:application
